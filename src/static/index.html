<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>SightQuest</title>
    <link rel="stylesheet" href="/static/style.css" />
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_SY-hHyH0FqMRqEv1VKa0gV1b4bqPrDk&libraries=places&v=weekly"
      async
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              border: "hsl(var(--border))",
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              primary: {
                DEFAULT: "#18181b", // Zinc-900 (Matches your primary)
                foreground: "#fafafa",
              },
              secondary: {
                DEFAULT: "#f4f4f5", // Zinc-100
                foreground: "#18181b",
              },
              accent: {
                DEFAULT: "#f4f4f5",
                foreground: "#18181b",
              },
            },
            borderRadius: {
              lg: "0.625rem",
              md: "calc(0.625rem - 2px)",
              sm: "calc(0.625rem - 4px)",
            },
          },
        },
      };
    </script>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #ffffff;
        color: #09090b;
      }

      /* Smooth Animations */
      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Badge Pop Animation */
      @keyframes popIn {
        0% {
          transform: scale(0);
        }

        80% {
          transform: scale(1.1);
        }

        100% {
          transform: scale(1);
        }
      }

      .badge-pop {
        animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen pb-24">
    <header
      class="sticky top-0 z-50 w-full border-b bg-white/80 backdrop-blur-md px-6 py-4"
    >
      <div class="flex items-center justify-between max-w-md mx-auto">
        <div class="flex items-center gap-2">
          <div
            class="h-8 w-8 rounded-lg bg-black text-white flex items-center justify-center font-bold text-lg"
          >
            SQ
          </div>
          <span class="font-bold text-xl tracking-tight">SightQuest</span>
        </div>
        <div
          id="status-badge"
          class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200"
        >
          Connecting...
        </div>
        <a
          href="/static/achievements.html"
          class="flex items-center gap-1 px-3 py-1 rounded-full bg-indigo-50 hover:bg-indigo-100 transition border border-indigo-100"
        >
          <span>üèÜ</span>
          <span class="text-xs font-bold text-indigo-700">Rank</span>
        </a>
      </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">
      <div class="fade-in bg-white rounded-xl border shadow-sm overflow-hidden">
        <div class="p-6 space-y-4">
          <div class="flex justify-between items-start">
            <div>
              <p
                class="text-sm text-gray-500 font-medium uppercase tracking-wider"
              >
                Current Objective
              </p>
              <h2 class="text-3xl font-bold tracking-tight mt-1 text-gray-900">
                Find the <span class="text-indigo-600">Totem Pole</span>
              </h2>
            </div>
          </div>

          <div
            class="relative overflow-hidden rounded-lg bg-indigo-50 border border-indigo-100 p-4"
          >
            <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
            <div class="flex gap-3">
              <span class="text-xl">üîÆ</span>
              <div>
                <h3 class="text-xs font-bold text-indigo-900 uppercase mb-1">
                  Oracle's Clue
                </h3>
                <p
                  id="riddle-text"
                  class="text-sm text-indigo-800 italic leading-relaxed"
                >
                  Summoning the Oracle...
                </p>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4 pt-2">
            <div
              class="p-3 bg-gray-50 rounded-lg border border-gray-100 text-center"
            >
              <p class="text-xs text-gray-500 uppercase">Distance</p>
              <p
                id="distance"
                class="text-2xl font-mono font-bold text-gray-900"
              >
                --- m
              </p>
            </div>
            <div
              class="p-3 bg-gray-50 rounded-lg border border-gray-100 text-center flex flex-col justify-center items-center"
            >
              <p class="text-xs text-gray-500 uppercase">Accuracy</p>
              <p class="text-sm font-medium text-green-600">High GPS</p>
            </div>
          </div>

          <input
            type="file"
            id="camera-input"
            accept="image/*"
            style="display: none"
            onchange="processImage()"
          />

          <button
            id="cam-btn"
            onclick="document.getElementById('camera-input').click()"
            disabled
            class="w-full py-4 px-6 rounded-xl font-bold text-white shadow-md transition-all duration-200 bg-gray-300 cursor-not-allowed flex items-center justify-center gap-2"
          >
            <span>üì∏</span>
            <span id="btn-text">Get Closer to Unlock</span>
          </button>
        </div>
      </div>

      <div class="fade-in bg-white rounded-xl border shadow-sm p-6">
        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
          <span>üõÇ</span> My Passport
        </h3>

        <div
          id="badges-container"
          class="flex flex-wrap gap-2 mb-6 min-h-[40px]"
        >
          <span class="text-sm text-gray-400 italic py-2"
            >No badges earned yet...</span
          >
        </div>

        <div class="border-t border-gray-100 my-4"></div>

        <div class="space-y-3" id="stamps-list">
          <div class="text-center py-4">
            <div
              class="animate-spin h-5 w-5 border-2 border-gray-300 border-t-indigo-600 rounded-full mx-auto"
            ></div>
          </div>
        </div>
      </div>

      <div
        class="bg-gray-50 rounded-xl border border-dashed border-gray-300 p-4 opacity-75 hover:opacity-100 transition-opacity"
      >
        <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">
          Hackathon Demo Tools
        </h4>
        <div class="grid grid-cols-3 gap-2 mb-2">
          <button
            onclick="simulateFind('Stanley Park', 'Park')"
            class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-medium hover:bg-gray-100 shadow-sm"
          >
            + Park 1
          </button>
          <button
            onclick="simulateFind('Central Park', 'Park')"
            class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-medium hover:bg-gray-100 shadow-sm"
          >
            + Park 2
          </button>
          <button
            onclick="simulateFind('Queen E Park', 'Park')"
            class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-medium hover:bg-gray-100 shadow-sm"
          >
            + Park 3
          </button>
        </div>
        <button
          onclick="resetPassport()"
          class="w-full px-3 py-2 bg-red-50 text-red-600 border border-red-100 rounded-lg text-xs font-medium hover:bg-red-100"
        >
          üóë Reset Database
        </button>
      </div>
    </main>

    <button
      onclick="toggleGodMode()"
      id="god-btn"
      class="fixed bottom-6 right-6 h-12 w-12 bg-white text-yellow-500 rounded-full shadow-lg border border-gray-200 flex items-center justify-center text-xl z-50 hover:scale-110 transition-transform"
    >
      ‚ö°Ô∏è
    </button>
    <div id="map"></div>
    <select id="category">
      <option value="Park">üèûÔ∏è Park</option>
      <option value="History" selected>üèõÔ∏è History</option>
      <option value="Food">üçî Food</option>
    </select>

    <script>
      // --- 1. CORE GPS LOGIC ---
      function startTracking() {
        if (!navigator.geolocation) {
          document.getElementById("status-badge").innerText = "No GPS";
          return;
        }
        navigator.geolocation.watchPosition(sendPosition, showError, {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000,
        });
      }

      async function sendPosition(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        try {
          const response = await fetch("/check-proximity", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat: lat, lon: lon }),
          });

          const data = await response.json();

          // Update UI
          document.getElementById("distance").innerText =
            Math.round(data.distance_remaining) + " m";

          const badge = document.getElementById("status-badge");
          const btn = document.getElementById("cam-btn");
          const btnText = document.getElementById("btn-text");

          if (data.can_verify) {
            // UNLOCKED STATE
            badge.innerText = "Target Nearby";
            badge.className =
              "px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200";

            btn.disabled = false;
            btn.classList.remove("bg-gray-300", "cursor-not-allowed");
            btn.classList.add(
              "bg-black",
              "hover:bg-gray-800",
              "cursor-pointer",
            ); // Primary Color
            btnText.innerText = "Snap Photo";
          } else {
            // LOCKED STATE
            badge.innerText = "Searching...";
            badge.className =
              "px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200";

            btn.disabled = true;
            btn.classList.add("bg-gray-300", "cursor-not-allowed");
            btn.classList.remove(
              "bg-black",
              "hover:bg-gray-800",
              "cursor-pointer",
            );
            btnText.innerText =
              "Get Closer (" + Math.round(data.distance_remaining) + "m)";
          }
        } catch (error) {
          console.error("API Error", error);
        }
      }

      function showError(error) {
        document.getElementById("status-badge").innerText = "GPS Error";
      }

      // --- 2. IMAGE LOGIC ---
      async function processImage() {
        const input = document.getElementById("camera-input");
        if (input.files.length === 0) return;

        const file = input.files[0];
        const btn = document.getElementById("cam-btn");
        const btnText = document.getElementById("btn-text");

        // UI: Loading
        const oldText = btnText.innerText;
        btnText.innerText = "Analyzing...";
        btn.classList.replace("bg-black", "bg-indigo-600"); // Purple loading state

        const reader = new FileReader();
        reader.readAsDataURL(file);

        reader.onload = async function () {
          const base64String = reader.result;

          navigator.geolocation.getCurrentPosition(async (position) => {
            try {
              const res = await fetch("/verify-image", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  image_b64: base64String,
                  lat: position.coords.latitude,
                  lon: position.coords.longitude,
                }),
              });

              const data = await res.json();

              if (data.success) {
                alert("‚úÖ MATCH CONFIRMED!\n" + data.message);
                if (data.new_badge)
                  alert("üéâ BADGE UNLOCKED: " + data.new_badge);
                loadProfile();
              } else {
                alert("‚ùå " + data.message);
              }
            } catch (e) {
              console.error(e);
              alert("Upload failed. Check console.");
            } finally {
              // Reset UI
              btnText.innerText = oldText;
              btn.classList.replace("bg-indigo-600", "bg-black");
              input.value = "";
            }
          });
        };
      }

      // --- 3. PASSPORT LOGIC ---
      async function loadProfile() {
        try {
          const res = await fetch("/my-profile");
          const data = await res.json();

          // Render Badges
          const badgeDiv = document.getElementById("badges-container");
          badgeDiv.innerHTML = "";
          if (data.badges.length === 0) {
            badgeDiv.innerHTML =
              '<span class="text-sm text-gray-400 italic py-2">No badges yet...</span>';
          } else {
            data.badges.forEach((b) => {
              badgeDiv.innerHTML += `
                <span class="badge-pop inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200 shadow-sm">
                  üèÜ ${b}
                </span>`;
            });
          }

          // Render Stamps
          const listDiv = document.getElementById("stamps-list");
          listDiv.innerHTML = "";
          if (data.stamps.length === 0) {
            listDiv.innerHTML =
              '<div class="text-sm text-gray-400 text-center py-4">Your passport is empty.</div>';
          } else {
            data.stamps
              .slice()
              .reverse()
              .forEach((s) => {
                listDiv.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <div class="flex items-center gap-3">
                            <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-lg">üìç</div>
                            <div>
                                <p class="text-sm font-bold text-gray-900">${s.name}</p>
                                <p class="text-xs text-gray-500">${s.date}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 rounded text-[10px] font-bold bg-gray-200 text-gray-600 uppercase tracking-wide">${s.category}</span>
                    </div>`;
              });
          }
        } catch (e) {
          console.error("Profile Error", e);
        }
      }

      // --- 4. EXTRAS ---
      async function simulateFind(name, category) {
        await fetch("/collect-stamp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ poi_name: name, category: category }),
        });
        loadProfile();
      }

      async function loadRiddle() {
        try {
          const res = await fetch("/get-riddle");
          const data = await res.json();
          document.getElementById("riddle-text").innerText = data.riddle;
        } catch (e) {}
      }

      async function toggleGodMode() {
        await fetch("/toggle-god-mode?enable=true", { method: "POST" });
        alert("‚ö°Ô∏è God Mode Enabled: Verification unlocked everywhere.");
        document
          .getElementById("god-btn")
          .classList.add("ring-4", "ring-yellow-300");
      }

      async function resetPassport() {
        if (!confirm("Reset everything?")) return;
        await fetch("/reset-db", { method: "POST" });
        loadProfile();
      }

      // Init
      document.addEventListener("DOMContentLoaded", () => {
        loadProfile();
        loadRiddle();
        startTracking();
      });
    </script>
    <script src="/static/app.js"></script>
  </body>
</html>
